{% extends "website/base.html" %}
{% load user_display %}
{% load static %}
{% load get_item %}

{% block extra_head %}
<style>
    /* Make manage rooms page use full width */
    .main-content { max-width: 100%; margin: 0; padding: 0; }
</style>
{% endblock %}

{% block main-content %}
<link rel="stylesheet" href="{% static 'css/mange_rooms.css' %}">

{# ƒê√£ g·ª° ph·∫ßn th√¥ng b√°o vi ph·∫°m theo y√™u c·∫ßu #}

<div class="header">
    <div class="container">
        <h1><i class="fas fa-home"></i> QU·∫¢N L√ù PH√íNG TR·ªå</h1>
        <div class="user-info">

        </div>
    </div>
</div>

<div class="main-container">
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
            <div class="user-profile">
                <p>
                    <strong>Xin ch√†o {{ request.user|display_name }}</strong><br>
                    {{ request.user.username }}
                </p>
            </div>
        </div>

        <div class="sidebar-menu">
            <ul class="menu-list">
                <li>
                    <a href="{% url 'post_create' %}">
                        <i class="fas fa-plus-circle"></i> ƒêƒÉng tin m·ªõi
                    </a>
                </li>
                <li><a href="#" class="active"><i class="fas fa-list"></i> Danh s√°ch tin ƒëƒÉng</a></li>
                <li><a href="{% url 'rental_management' %}"><i class="fas fa-handshake"></i> Qu·∫£n l√Ω thu√™</a></li>
                <li><a href="{% url 'expired_posts' %}"><i class="fas fa-clock"></i> B√†i ƒëƒÉng h·∫øt h·∫°n</a></li>
                <li><a href="{% url 'recharge' %}"><i class="fas fa-credit-card"></i> N·∫°p ti·ªÅn v√†o t√†i kho·∫£n</a></li>
                <li><a href="{% url 'bang_gia_dich_vu' %}"><i class="fas fa-tags"></i> B·∫£ng gi√° d·ªãch v·ª•</a></li>
                <li><a href="{% url 'account_settings' %}"><i class="fas fa-user-cog"></i> Qu·∫£n l√Ω t√†i kho·∫£n</a></li>
                <li><a href="{% url 'deletion_logs' %}"><i class="fas fa-history"></i> Nh·∫≠t k√Ω x√≥a</a></li>
                <li><a href="{% url 'logout' %}"><i class="fas fa-sign-out-alt"></i> ƒêƒÉng xu·∫•t</a></li>
            </ul>
        </div>
    </div>

    <!-- Content -->
    <div class="content">
        <!-- Content Header -->
        <div class="content-header">
            <h2 class="content-title">Danh s√°ch tin ƒëƒÉng</h2>
        </div>

        <!-- Stats Cards -->
        <div class="stats-cards">
            <a href="?status=all" class="stat-card" style="text-decoration:none; color:inherit;">
                <div class="stat-number">{{ total_count }}</div>
                <div class="stat-label">T·ªïng tin ƒëƒÉng</div>
            </a>
            <a href="?status=display" class="stat-card" style="text-decoration:none; color:inherit;">
                <div class="stat-number">{{ display_count }}</div>
                <div class="stat-label">ƒêang hi·ªÉn th·ªã</div>
            </a>
            <a href="?status=vacant" class="stat-card" style="text-decoration:none; color:inherit;">
                <div class="stat-number">{{ vacant_count }}</div>
                <div class="stat-label">C√≤n tr·ªëng</div>
            </a>
            <a href="?status=pending" class="stat-card" style="text-decoration:none; color:inherit;">
                <div class="stat-number">{{ pending_count }}</div>
                <div class="stat-label">ƒêang ch·ªù duy·ªát</div>
            </a>
            <a href="?status=rented" class="stat-card" style="text-decoration:none; color:inherit;">
                <div class="stat-number">{{ rented_count }}</div>
                <div class="stat-label">ƒê√£ cho thu√™</div>
            </a>
            <a href="{% url 'expired_posts' %}" class="stat-card" style="text-decoration:none; color:inherit; background:#f59e0b;">
                <div class="stat-number" style="color:white;">{{ expired_count }}</div>
                <div class="stat-label" style="color:white;">H·∫øt h·∫°n</div>
            </a>
            <a href="?status=removed" class="stat-card" style="text-decoration:none; color:inherit; background:#dc2626;">
                <div class="stat-number" style="color:white;">{{ removed_count }}</div>
                <div class="stat-label" style="color:white;">Admin ƒë√£ g·ª° v√† t·ª´ ch·ªëi</div>
            </a>
        </div>

        <!-- Search Box -->
        <form method="get" action="{% url 'manage_rooms' %}" class="search-box">
            <input type="text" name="search" value="{{ search_query }}" placeholder="T√¨m theo m√£ tin ho·∫∑c ti√™u ƒë·ªÅ...">
            <button type="submit" style="background:none; border:none; cursor:pointer;">
                <i class="fas fa-search"></i>
            </button>
        </form>

        {% if rooms %}
        <table class="room-table">
            <thead>
                <tr>
                    <th>Ti√™u ƒë·ªÅ & ƒê·ªãa ƒëi·ªÉm</th>
                    <th>Gi√° thu√™</th>
                    <th>Ng√†y ƒëƒÉng</th>
                    <th>Ng√†y h·∫øt h·∫°n</th>
                    <th>Tr·∫°ng th√°i</th>
                    <th>H√†nh ƒë·ªông</th>
                </tr>
            </thead>
            <tbody>
            {% for room in rooms %}
                <tr>
                    <td>
                        <div class="room-title"><a href="{% url 'post_detail' room.id %}">{{ room.title }}</a></div>
                        <div class="room-location">
                            {% if room.district %}
                                {{ room.district.name }}
                            {% elif room.province %}
                                {{ room.province.name }}
                            {% else %}
                                Ch∆∞a c·∫≠p nh·∫≠t
                            {% endif %}
                        </div>
                    </td>
                    <td><div class="room-price">{{ room.price|floatformat:0 }} tri·ªáu/th√°ng</div></td>
                    <td>{{ room.created_at|date:"d/m/Y" }}</td>
                    <td>
                        {% if room.expired_at %}
                            <div class="{% if room.expired_at < now %}text-danger{% else %}text-success{% endif %}">
                                {{ room.expired_at|date:"d/m/Y H:i" }}
                            </div>
                        {% else %}
                            <span class="text-muted">Kh√¥ng gi·ªõi h·∫°n</span>
                        {% endif %}
                    </td>
                    <td>
                    <td>
                        {% if room.is_rejected %}
                            <span class="status-badge" style="background:#dc2626;color:#fff">‚ùå B·ªã t·ª´ ch·ªëi do vi ph·∫°m</span>
                            {% if room.rejected_at %}
                                <div style="font-size:11px;color:#6b7280;margin-top:4px">
                                    {{ room.rejected_at|date:"d/m/Y H:i" }}
                                </div>
                            {% endif %}
                            {% if room.rejection_reason %}
                                <div style="font-size:11px;color:#dc2626;margin-top:4px;font-weight:500">
                                    {{ room.rejection_reason|truncatewords:15 }}
                                </div>
                            {% endif %}
                        {% elif room.is_deleted or room.was_auto_removed and not room.is_approved %}
                            <span class="status-badge" style="background:#dc2626;color:#fff">üö´ Admin ƒë√£ g·ª°</span>
                            {% if room.deleted_at %}
                                <div style="font-size:11px;color:#6b7280;margin-top:4px">
                                    {{ room.deleted_at|date:"d/m/Y H:i" }}
                                </div>
                            {% endif %}
                        {% elif room.expired_at and room.expired_at <= now %}
                            <span class="status-badge" style="background:#ef4444;color:#fff">H·∫øt h·∫°n</span>
                        {% elif not room.is_approved %}
                            <span class="status-badge" style="background:#f59e0b;color:#fff">ƒêang duy·ªát</span>
                        {% elif room.is_approved %}
                            <span class="status-badge" style="background:#10b981;color:#fff">ƒê√£ duy·ªát</span>
                        {% endif %}
                        {% if not room.is_deleted and not room.is_rejected and room.is_approved %}
                            {% if room.is_rented %}
                                <span class="status-badge status-expired">ƒê√£ cho thu√™</span>
                            {% else %}
                                <span class="status-badge status-active">C√≤n tr·ªëng</span>
                            {% endif %}
                        {% endif %}
                    </td>
                    <td>
                        <div class="action-buttons">
                            {% if room.is_rejected %}
                                <!-- B√†i b·ªã t·ª´ ch·ªëi do vi ph·∫°m: Ch·ªâ cho X√ìA -->
                                <span style="color:#dc2626; font-weight:600; font-size:13px; display:block; margin-bottom:8px">
                                    <i class="fas fa-ban"></i> Tin b·ªã t·ª´ ch·ªëi do vi ph·∫°m
                                </span>
                                <a href="{% url 'delete_room' room.id %}" class="btn-action btn-delete" title="X√≥a tin ƒëƒÉng" onclick="return confirm('X√≥a tin n√†y?')">
                                    <i class="fas fa-trash"></i><span style="margin-left:4px">X√≥a</span>
                                </a>
                            {% elif room.is_deleted or room.was_auto_removed and not room.is_approved %}
                                <!-- B√†i ƒë√£ b·ªã admin g·ª°: Ch·ªâ cho xem v√† x√≥a -->
                                <span style="color:#dc2626; font-weight:600; font-size:13px; display:block; margin-bottom:8px">
                                    <i class="fas fa-ban"></i> B√†i ƒë√£ b·ªã admin g·ª° do vi ph·∫°m
                                </span>
                                <a href="{% url 'post_detail' room.id %}" class="btn-action btn-view" title="Xem chi ti·∫øt">
                                    <i class="fas fa-eye"></i><span style="margin-left:4px">Xem</span>
                                </a>
                                <a href="{% url 'delete_room' room.id %}" class="btn-action btn-delete" title="X√≥a tin ƒëƒÉng" onclick="return confirm('X√≥a tin n√†y?')">
                                    <i class="fas fa-trash"></i><span style="margin-left:4px">X√≥a</span>
                                </a>
                            {% elif room.is_rented %}
                                <!-- Khi ƒë√£ cho thu√™: Kh√¥ng cho s·ª≠a/x√≥a, ch·ªâ hi·ªÉn th·ªã c·∫£nh b√°o -->
                                <span style="color:#ef4444; font-weight:600; font-size:13px; display:block; margin-bottom:8px">
                                    <i class="fas fa-lock"></i> ƒê√£ cho thu√™ - Vui l√≤ng h·ªßy ph√≤ng ƒë·ªÉ ch·ªânh s·ª≠a
                                </span>
                            {% else %}
                                <!-- Khi ch∆∞a cho thu√™: Hi·ªÉn th·ªã ƒë·∫ßy ƒë·ªß ch·ª©c nƒÉng -->
                                <a href="{% url 'post_detail' room.id %}" class="btn-action btn-view" title="Xem chi ti·∫øt">
                                    <i class="fas fa-eye"></i><span style="margin-left:4px">Xem</span>
                                </a>
                                <a href="{% url 'edit_room' room.id %}" class="btn-action btn-edit" title="Ch·ªânh s·ª≠a tin ƒëƒÉng">
                                    <i class="fas fa-edit"></i><span style="margin-left:4px">S·ª≠a</span>
                                </a>
                                <a href="{% url 'delete_room' room.id %}" class="btn-action btn-delete" title="X√≥a tin ƒëƒÉng" onclick="return confirm('X√≥a tin n√†y?')">
                                    <i class="fas fa-trash"></i><span style="margin-left:4px">X√≥a</span>
                                </a>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                        {% endfor %}
                        </tbody>
                </table>
        {% else %}
        <div class="empty-state">
            <div class="empty-state-icon">
                <i class="fas fa-home"></i>
            </div>
            <h3>Ch∆∞a c√≥ tin ƒëƒÉng</h3>
            <p>B·∫°n ch∆∞a c√≥ tin ƒëƒÉng n√†o. H√£y b·∫Øt ƒë·∫ßu ƒëƒÉng tin ƒë·ªÉ t√¨m ng∆∞·ªùi thu√™ tr·ªç.</p>
            <a href="{% url 'post_create' %}" class="btn-add">
                <i class="fas fa-plus"></i> B·∫Øt ƒë·∫ßu ƒëƒÉng tin
            </a>
        </div>
        {% endif %}
    </div>
</div>

<script>
    // Search functionality
    document.querySelector('.search-box input').addEventListener('input', function(e) {
        const searchTerm = e.target.value.toLowerCase();
        console.log('Searching for:', searchTerm);
    });

    // Filter tabs functionality
    document.querySelectorAll('.filter-tabs a').forEach(tab => {
        tab.addEventListener('click', function(e) {
            e.preventDefault();
            document.querySelectorAll('.filter-tabs a').forEach(t => t.classList.remove('active'));
            this.classList.add('active');
            console.log('Filter changed to:', this.textContent);
        });
    });

    // Delete confirmation
    document.querySelectorAll('.btn-delete').forEach(btn => {
        btn.addEventListener('click', function(e) {
            if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a tin ƒëƒÉng n√†y?')) {
                e.preventDefault();
            }
        });
    });

    // Toggle rented
    document.addEventListener('click', function(e){
        const btn = e.target.closest('[data-toggle-rented]');
        if(!btn) return;
        const id = btn.getAttribute('data-toggle-rented');
        fetch(`/rooms/${id}/toggle-rented/`, {
            method: 'POST',
            headers: { 'X-CSRFToken': '{{ csrf_token }}' }
        }).then(async r=>{
            let d = {};
            try { d = await r.json(); } catch(e) {}
            if (r.ok && d.status==='ok') {
                location.reload();
            } else {
                alert(d.message || 'Kh√¥ng ƒë·ªïi ƒë∆∞·ª£c tr·∫°ng th√°i');
            }
        }).catch(()=> alert('L·ªói m·∫°ng'));
    });
</script>
{% endblock %}
