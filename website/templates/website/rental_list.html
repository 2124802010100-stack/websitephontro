{% extends "website/base.html" %}
{% load user_display %}
{% load static %}
{% load vip_tags %}
{% block main-content %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.3/css/lightbox.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.3/js/lightbox.min.js"></script>
<!-- Material Icons -->
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

<link rel="stylesheet" href="{% static 'css/home.css' %}">

<main class="container wrapper" role="main">
  <div class="main-content">
    <div class="banner">
      <!-- Inline filter selects: giữ UI giống home -->
      <div class="location-filter" style="display:flex;gap:12px;align-items:center;background:white;padding:20px;border-radius:12px;box-shadow:0 2px 12px rgba(0,0,0,0.08);">
        <form id="inline-filter-form" method="get" action="{% url 'rental_list' %}" style="display:flex;gap:12px;align-items:center;width:100%;">
          <select id="bar-province" name="province" style="flex:1;min-width:180px;padding:12px 16px;border-radius:8px;border:2px solid #7c3aed;font-size:14px;color:#5b21b6;font-weight:500;background:white;cursor:pointer;transition:all 0.3s;">
            <option value="">-- Chọn tỉnh/thành --</option>
            {% for p in provinces %}
              <option value="{{ p.id }}" {% if province_id == p.id|stringformat:"s" %}selected{% endif %}>{{ p.name }}</option>
            {% endfor %}
          </select>

          <select id="bar-district" name="district" style="flex:1;min-width:200px;padding:12px 16px;border-radius:8px;border:2px solid #7c3aed;font-size:14px;color:#5b21b6;font-weight:500;background:white;cursor:pointer;transition:all 0.3s;">
            <option value="">-- Chọn quận/huyện --</option>
          </select>

          <select id="bar-ward" name="ward" style="flex:1;min-width:180px;padding:12px 16px;border-radius:8px;border:2px solid #7c3aed;font-size:14px;color:#5b21b6;font-weight:500;background:white;cursor:pointer;transition:all 0.3s;">
            <option value="">-- Chọn phường/xã --</option>
          </select>

          <button type="submit" style="padding:10px 24px;background:linear-gradient(135deg,#7c3aed 0%,#5b21b6 100%);color:white;border:none;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;transition:all 0.3s;box-shadow:0 4px 12px rgba(123,58,237,0.3);text-transform:uppercase;letter-spacing:0.5px;">
            <span style="display:inline-flex;align-items:center;gap:6px;">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                <circle cx="11" cy="11" r="8"/>
                <path d="m21 21-4.35-4.35"/>
              </svg>
              Tìm Kiếm
            </span>
          </button>
        </form>
      </div>
    </div>

    {# LOOP POSTS: dùng page_obj #}
    {% for post in page_obj %}
      {% comment %} reuse your existing card layout: first 5 use one style, others alternate {% endcomment %}
      {% if forloop.counter0 < 5 %}
        <!-- First layout (same as your home) -->
        <article class="rental-card">
          <section class="image-gallery">
            {% with post.images.all|slice:":4" as images %}
              {% with post.videos.all|slice:":4" as videos %}
                {% with images|length|add:videos|length as total_items %}
                  {% if images|length > 0 %}
                    <div class="image-gallery-item">
                      <a href="{{ images.0.image.url }}" data-lightbox="gallery{{ post.id }}">
                        <img src="{{ images.0.image.url }}" alt="">
                      </a>
                    </div>
                  {% endif %}
                  {% for i in images|slice:"1:4" %}
                    <div class="image-gallery-item">
                      <a href="{{ i.image.url }}" data-lightbox="gallery{{ post.id }}">
                        <img src="{{ i.image.url }}" alt="">
                      </a>
                    </div>
                  {% endfor %}
                  {% for vid in videos %}
                    <div class="image-gallery-item">
                      <a href="{{ vid.video.url }}" data-lightbox="gallery{{ post.id }}" data-type="video/mp4">
                        <video muted loop>
                          <source src="{{ vid.video.url }}" type="video/mp4">
                        </video>
                      </a>
                    </div>
                  {% endfor %}
                {% endwith %}
              {% endwith %}
            {% endwith %}
          </section>

          <section class="content">
            <div class="title-section">
              <h2 class="title">
  <a href="{% url 'post_detail' post.id %}" style="color:{% vip_style_color post.user %}">{{ post.title }}</a>
</h2>

              <div class="stars">
                {% vip_star_count post.user as stars %}
                {% for _ in "x"|rjust:stars %}
                  <span class="material-icons">star</span>
                {% endfor %}
              </div>
            </div>

            <div class="price-info">
              <div class="price">{{ post.price|floatformat:0 }} triệu/tháng</div>
              <div class="area">{{ post.area }} m²</div>
              <div class="location">{{ post.address }}</div>
            </div>

            <p class="description">{{ post.description|truncatewords:20 }}</p>

            {% if post.features_list %}
            <div class="mt-2 text-xs text-gray-600">
              <strong class="block mb-1">Đặc điểm nổi bật:</strong>
              {{ post.features_list|join:", " }}
            </div>
            {% endif %}

            <div class="contact-row">
              <div class="contact-info">
                <div class="avatar">{% with name=post.user|display_name %}{{ name|first|default:"?"|upper }}{% endwith %}</div>
                <div class="contact-details">
                  <span class="contact-name">{{ post.user|display_name }}</span>
                   <span class="contact-time">{{ post.created_at|timesince_vi }} trước</span>
                </div>
              </div>
              <div class="contact-actions">
                <button class="phone-button"><span class="material-icons">phone</span> {{ post.phone_number|default:"096176889" }}</button>
                <span class="material-icons favorite-icon" role="button" tabindex="0">favorite_border</span>
              </div>
            </div>
          </section>
        </article>

      {% else %}
        <!-- Alternate layout for later posts (same as your home) -->
        <article class="rental-card alternate-layout">
          <section class="image-gallery alternate-gallery">
            {% with post.images.all|slice:":3" as images %}
              {% for i in images %}
                <div class="image-gallery-item">
                  <a href="{{ i.image.url }}" data-lightbox="gallery{{ post.id }}">
                    <img src="{{ i.image.url }}" alt="">
                  </a>
                </div>
              {% endfor %}
            {% endwith %}
          </section>

          <section class="content alternate-content">
            <div class="title-section">
              <h2 class="title">
  <a href="{% url 'post_detail' post.id %}" style="color:{% vip_style_color post.user %}">{{ post.title }}</a>
</h2>

              <div class="stars">
                {% vip_star_count post.user as stars2 %}
                {% for _ in "x"|rjust:stars2 %}
                  <span class="material-icons">star</span>
                {% endfor %}
              </div>
            </div>
            <div class="price-info">
              <div class="price">{{ post.price|floatformat:0 }} triệu/tháng</div>
              <div class="area">{{ post.area }} m²</div>
            </div>
            <div class="location"><span class="material-icons" style="font-size:16px;">location_on</span> {{ post.address }}</div>
            <p class="description">{{ post.description|truncatewords:20 }}</p>

            <div class="contact-row">
              <div class="contact-info">
                <div class="avatar">{% with name=post.user|display_name %}{{ name|first|default:"?"|upper }}{% endwith %}</div>
                <div>
                  <span class="contact-name">{{ post.user|display_name }}</span>
                   <div class="contact-time">{{ post.created_at|timesince_vi }} trước</div>
                </div>
              </div>
              <button class="phone-button"><span class="material-icons">phone</span> {{ post.phone|default:"0983230272" }}</button>
              <span class="material-icons favorite-icon" role="button" tabindex="0">favorite_border</span>
            </div>
          </section>
        </article>
      {% endif %}
    {% endfor %}

  </div>

  <aside class="sidebar">
    <!-- Sidebar giống home -->
    <aside class="sidebar">
      <div class="sidebar-section">
        <h3>Xem theo khoảng giá</h3>
        <div class="price-filter">
          <a href="?price=0-1000000">Dưới 1 triệu</a>
          <a href="?price=1000000-2000000">Từ 1 - 2 triệu</a>
          <a href="?price=2000000-3000000">Từ 2 - 3 triệu</a>
          <a href="?price=3000000-5000000">Từ 3 - 5 triệu</a>
          <a href="?price=5000000-7000000">Từ 5 - 7 triệu</a>
          <a href="?price=7000000-10000000">Từ 7 - 10 triệu</a>
          <a href="?price=10000000-15000000">Từ 10 - 15 triệu</a>
          <a href="?price=15000000-999999999">Trên 15 triệu</a>

        </div>
      </div>
      <div class="sidebar-section">
        <h3>Xem theo diện tích</h3>
        <div class="area-filter">
          <a href="?area=0-20">Dưới 20m²</a>
          <a href="?area=20-30">Từ 20 - 30m²</a>
          <a href="?area=30-50">Từ 30 - 50m²</a>
          <a href="?area=50-70">Từ 50 - 70m²</a>
          <a href="?area=70-90">Từ 70 - 90m²</a>
          <a href="?area=90-999">Trên 90m²</a>
        </div>
      </div>

    <div class="sidebar-section">
      <h3>Tin mới đăng</h3>
      {% for recent_post in recent_posts %}
      <a href="{% url 'post_detail' recent_post.id %}" class="recent-post" style="text-decoration:none;color:inherit;display:flex;gap:12px;align-items:center;">
        <div style="width:84px;height:64px;flex:0 0 84px;overflow:hidden;border-radius:8px;background:#f3f4f6;">
          {% with recent_post.images.all|first as thumb %}
            {% if thumb %}
              <img src="{{ thumb.image.url }}" alt="{{ recent_post.title }}" style="width:100%;height:100%;object-fit:cover;" />
            {% endif %}
          {% endwith %}
        </div>
        <div class="recent-post-content" style="flex:1;">
          {% vip_style_color recent_post.user as recent_vip_color %}
          <div class="recent-post-title" style="font-weight:600;line-height:1.3;color:{% if recent_vip_color %}{{ recent_vip_color }}{% else %}#1e293b{% endif %};">{{ recent_post.title|truncatechars:50 }}</div>
          <div class="recent-post-price" style="color:#16a34a;font-weight:600;margin-top:2px;">{{ recent_post.price|floatformat:0 }} triệu/tháng</div>
           <div class="recent-post-time" style="color:#6b7280;font-size:12px;margin-top:2px;">{{ recent_post.created_at|timesince_vi }} trước</div>
        </div>
      </a>
      {% endfor %}
    </div>
  </aside>

</main>

<script>
  // same small scripts as in home: favorite toggle + lightbox init
  document.querySelectorAll('.favorite-icon').forEach(favIcon => {
    favIcon.addEventListener('click', () => {
      favIcon.textContent = favIcon.textContent === 'favorite_border' ? 'favorite' : 'favorite_border';
      favIcon.style.color = favIcon.textContent === 'favorite' ? '#dc3545' : '#ccc';
    });
  });

  document.addEventListener('DOMContentLoaded', function() {
    lightbox.option({'resizeDuration': 200, 'wrapAround': true});
  });
</script>

<!-- Pagination (same pattern as your home bottom) -->
<div class="pagination" style="text-align:center;margin:20px 0;">
  {% if page_obj.has_previous %}
    <a href="?page={{ page_obj.previous_page_number }}{% if province_id %}&province={{ province_id }}{% endif %}{% if district_id %}&district={{ district_id }}{% endif %}{% if ward_id %}&ward={{ ward_id }}{% endif %}">Trang trước</a>
  {% endif %}
  <span> Trang {{ page_obj.number }} / {{ page_obj.paginator.num_pages }} </span>
  {% if page_obj.has_next %}
    <a href="?page={{ page_obj.next_page_number }}{% if province_id %}&province={{ province_id }}{% endif %}{% if district_id %}&district={{ district_id }}{% endif %}{% if ward_id %}&ward={{ ward_id }}{% endif %}">Trang sau</a>
  {% endif %}
</div>

<!-- JS: load districts/wards & prefill selects when page loads (so the inline filter shows previous selection) -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function(){
  const URL = {
    districts: "{% url 'ajax_load_districts' %}",
    wards:     "{% url 'ajax_load_wards' %}"
  };

  const selProvince = document.getElementById('bar-province');
  const selDistrict = document.getElementById('bar-district');
  const selWard = document.getElementById('bar-ward');

  function loadDistricts(provinceId, selectedDistrict){
    selDistrict.innerHTML = '<option value="">-- Chọn quận/huyện --</option>';
    selWard.innerHTML = '<option value="">-- Chọn phường/xã --</option>';
    if(!provinceId) return;
    $.getJSON(URL.districts, {province_id: provinceId}, function(data){
      data.forEach(function(d){
        const sel = (String(d.id) === String(selectedDistrict)) ? 'selected' : '';
        selDistrict.insertAdjacentHTML('beforeend', `<option value="${d.id}" ${sel}>${d.name}</option>`);
      });
      if(selectedDistrict){
        loadWards(selectedDistrict, "{{ ward_id }}");
      }
    });
  }

  function loadWards(districtId, selectedWard){
    selWard.innerHTML = '<option value="">-- Chọn phường/xã --</option>';
    if(!districtId) return;
    $.getJSON(URL.wards, {district_id: districtId}, function(data){
      data.forEach(function(w){
        const sel = (String(w.id) === String(selectedWard)) ? 'selected' : '';
        selWard.insertAdjacentHTML('beforeend', `<option value="${w.id}" ${sel}>${w.name}</option>`);
      });
    });
  }

  // When user changes province/district
  selProvince && selProvince.addEventListener('change', function(){ loadDistricts(this.value, ""); });
  selDistrict && selDistrict.addEventListener('change', function(){ loadWards(this.value, ""); });

  // Prefill if we have query params
  const prov = "{{ province_id }}";
  const dist = "{{ district_id }}";
  const ward = "{{ ward_id }}";
  if(prov){
    // load districts and set selected
    loadDistricts(prov, dist);
  }
});
</script>

{% endblock %}
